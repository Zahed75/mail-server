version: '3.8'

services:
  mailserver:
    build:
      context: .
      dockerfile: Dockerfile-mailserver
    container_name: mailserver-system
    hostname: mail.system.syscomatic.com
    domainname: system.syscomatic.com
    restart: unless-stopped
    ports:
      - "127.0.0.1:1025:25"
      - "127.0.0.1:1143:143"
      - "127.0.0.1:1587:587"
      - "127.0.0.1:1993:993"
      - "127.0.0.1:1465:465"
    environment:
      - DOMAIN=system.syscomatic.com
      - HOSTNAME=mail.system.syscomatic.com
      - POSTMASTER_ADDRESS=admin@system.syscomatic.com
      - POSTMASTER_PASSWORD=${POSTMASTER_PASSWORD}
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - maildata:/var/mail
      - mailstate:/var/mail-state
      - maillogs:/var/log/mail
      # REMOVE THESE LINES:
      # - ./postfix/main.cf:/etc/postfix/main.cf:ro
      # - ./dovecot/dovecot.conf:/etc/dovecot/dovecot.conf:ro
      # - ./dovecot/users:/etc/dovecot/users:ro
    networks:
      - mail-network
    depends_on:
      - database

  rainloop:
    image: hardware/rainloop:latest
    container_name: rainloop-system
    restart: unless-stopped
    ports:
      - "127.0.0.1:8081:80"
    environment:
      - RAINLOOP_ADMIN_LOGIN=admin
      - RAINLOOP_ADMIN_PASSWORD=${RAINLOOP_ADMIN_PASSWORD}
    volumes:
      - rainloop_data:/var/www/html/data
      - ./rainloop-config.ini:/var/www/html/data/_data_/_default_/configs/application.ini:ro
    networks:
      - mail-network
    depends_on:
      - mailserver

  database:
    image: mysql:8.0
    container_name: mail-db-system
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE: mailserver
      MYSQL_USER: mailuser
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
    volumes:
      - db_data:/var/lib/mysql
      - ./mysql-init.sql:/docker-entrypoint-initdb.d/init.sql:ro
    networks:
      - mail-network

networks:
  mail-network:
    driver: bridge

volumes:
  maildata:
  mailstate:
  maillogs:
  rainloop_data:
  db_data: